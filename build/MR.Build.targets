<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<Import Project="MR.Build.props" />
	<Import Project="Build.Info.props" />
	<Import Project="MR.Build.tasks" />
	
	<Target Name="TransformAssemblyInfo" BeforeTargets="CoreCompile">
		<PropertyGroup>
			<TransformedAssemblyInfo>$(IntermediateOutputPath)AssemblyInfo.Transformed.cs</TransformedAssemblyInfo>
		</PropertyGroup>
		<ItemGroup>
			<AssemblyInfoFiles
				Include="@(Compile)"
				Condition="$([System.Text.RegularExpressions.Regex]::IsMatch('%(Filename)', '.*AssemblyInfo'))" />
			
			<Transforms Include="-">
				<Find>AssemblyVersion\("\d+\.\d+\.\d+"\)</Find>
				<ReplaceWith>AssemblyVersion("$(VersionWithoutTag)")</ReplaceWith>
			</Transforms>
			<Transforms Include="-">
				<Find>AssemblyInformationalVersion\("\d+\.\d+\.\d+"\)</Find>
				<ReplaceWith>AssemblyInformationalVersion("$(Version)")</ReplaceWith>
			</Transforms>
			<Transforms Include="-">
				<Find>AssemblyDescription\(""\)</Find>
				<ReplaceWith>AssemblyDescription("$(AssemblyDescription)")</ReplaceWith>
			</Transforms>
		</ItemGroup>
			
		<MultiFileRegexTransform Files="@(AssemblyInfoFiles)" Transforms="@(Transforms)" Destination="$(TransformedAssemblyInfo)" />
		
		<ItemGroup>
			<Compile Remove="@(AssemblyInfoFiles)" />
			<Compile Include="$(TransformedAssemblyInfo)" />
			<FileWrites Include="$(TransformedAssemblyInfo)" />
		</ItemGroup>
	</Target>
	
	<Target Name="CopyArtifacts" AfterTargets="Build">
		<ItemGroup>
			<Artifacts Include="$(OutputPath)$(AssemblyName).dll;
								$(OutputPath)$(AssemblyName).pdb;
								$(OutputPath)$(AssemblyName).xml" />
			<ThisProject Include="@(Projects)" Condition="'%(Filename)' == '$(MSBuildProjectName)'" />
		</ItemGroup>
		<PropertyGroup>
			<Platform>@(ThisProject->'%(Platform)')</Platform>
		</PropertyGroup>
		<Copy SourceFiles="@(Artifacts)" DestinationFolder="$(BinariesDir)$(AssemblyName)\lib\$(Platform)" ContinueOnError="true" />
		<Message Text="$(MSBuildProjectName)" Importance="High" />
		<Message Text="@(ThisProject->'%(Platform)')" Importance="High" />
		<Message Text="$(Platform)" Importance="High" />
	</Target>
</Project>